import React, { useState } from 'react';
import axios from 'axios';

function DataEntryForm() {
const [rows, setRows] = useState([{ familyName: '', amount: '' }]);
const [showPreview, setShowPreview] = useState(false);
const [successMessage, setSuccessMessage] = useState('');
const [errorMessage, setErrorMessage] = useState('');

    const handleInputChange = (index, field, value) => {
        const updatedRows = [...rows];
        updatedRows[index][field] = value;
        setRows(updatedRows);
    };

    const handleAddRow = () => {
        setRows([...rows, { familyName: '', amount: '' }]);
    };

    const handleShowPreview = (e) => {
        e.preventDefault();

        // Basic validation
        if (rows.some(row => !row.familyName || !row.amount)) {
            setErrorMessage("Please fill in all fields before previewing.");
            return;
        }

        setShowPreview(true);
        setErrorMessage('');
    };

    const handleEdit = () => {
        setShowPreview(false);
    };

    const handleSubmit = async () => {
        try {
            await axios.post('/api/family/batch', { data: rows });
            setRows([{ familyName: '', amount: '' }]);
            setSuccessMessage('Data successfully submitted!');
            setErrorMessage('');
            setShowPreview(false);
        } catch (error) {
            console.error('Error submitting data:', error);
            setErrorMessage('Failed to submit data. Please try again.');
        }
    };

    return (
        <div>
            <h2>Family Contribution Entry</h2>
            {errorMessage && <p style={{ color: 'red' }}>{errorMessage}</p>}
            {successMessage && <p style={{ color: 'green' }}>{successMessage}</p>}

            {!showPreview ? (
                <form onSubmit={handleShowPreview}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                            <tr>
                                <th>Family Name</th>
                                <th>Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {rows.map((row, index) => (
                                <tr key={index}>
                                    <td>
                                        <input
                                            type="text"
                                            value={row.familyName}
                                            onChange={(e) => handleInputChange(index, 'familyName', e.target.value)}
                                            required
                                        />
                                    </td>
                                    <td>
                                        <input
                                            type="number"
                                            value={row.amount}
                                            onChange={(e) => handleInputChange(index, 'amount', e.target.value)}
                                            required
                                        />
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    <button type="button" onClick={handleAddRow} style={{ marginTop: '10px' }}>Add Row</button>
                    <button type="submit" style={{ marginTop: '10px', marginLeft: '10px' }}>Preview</button>
                </form>
            ) : (
                <div>
                    <h3>Preview Your Entries</h3>
                    <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: '10px' }}>
                        <thead>
                            <tr>
                                <th>Family Name</th>
                                <th>Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {rows.map((row, index) => (
                                <tr key={index}>
                                    <td>{row.familyName}</td>
                                    <td>{row.amount}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    <button onClick={handleEdit} style={{ marginTop: '10px' }}>Edit</button>
                    <button onClick={handleSubmit} style={{ marginTop: '10px', marginLeft: '10px' }}>Submit</button>
                </div>
            )}
        </div>
    );

}

export default DataEntryForm;
